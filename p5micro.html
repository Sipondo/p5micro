<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>p5.js Micro Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            background: #1e1e1e;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        .editor-pane {
            width: 50%;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #333;
            background: #272822;
        }

        .editor-header {
            background: #1e1e1e;
            color: #fff;
            padding: 10px;
            font-size: 14px;
            border-bottom: 2px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .run-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            transition: background 0.3s;
        }

        .run-button:hover {
            background: #45a049;
        }

        .run-button:active {
            background: #3d8b40;
        }

        .CodeMirror {
            height: 100% !important;
            font-size: 14px;
        }

        .preview-pane {
            width: 50%;
            background: #fff;
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            background: #1e1e1e;
            color: #fff;
            padding: 10px;
            font-size: 14px;
            border-bottom: 2px solid #333;
        }

        .preview-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        #p5-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .error-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 10px;
            font-size: 12px;
            display: none;
            max-height: 30%;
            overflow-y: auto;
        }

        .error-overlay.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="editor-pane">
            <div class="editor-header">
                <span>Code Editor</span>
                <button class="run-button" onclick="runCode()">â–¶ Run (Ctrl+Enter)</button>
            </div>
            <textarea id="code-editor"></textarea>
        </div>
        <div class="preview-pane">
            <div class="preview-header">Preview</div>
            <div class="preview-content">
                <div id="p5-container"></div>
                <div id="error-overlay" class="error-overlay"></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize CodeMirror
        const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: 'javascript',
            theme: 'monokai',
            lineNumbers: true,
            tabSize: 2,
            indentUnit: 2,
            lineWrapping: true,
            extraKeys: {
                "Ctrl-Enter": runCode,
                "Cmd-Enter": runCode
            }
        });

        // Default starter code
        const starterCode = `function setup() {
  createCanvas(400, 400);
}

function draw() {
  background(220);
  
  // Draw a circle that follows the mouse
  fill(100, 200, 255);
  circle(mouseX, mouseY, 50);
  
  // Draw some text
  fill(0);
  textAlign(CENTER, CENTER);
  text('Edit code and click Run!', width/2, 30);
}`;

        editor.setValue(starterCode);

        // P5.js sketch management
        let currentSketch = null;
        const errorOverlay = document.getElementById('error-overlay');

        function showError(message) {
            errorOverlay.textContent = message;
            errorOverlay.classList.add('show');
            setTimeout(() => {
                errorOverlay.classList.remove('show');
            }, 5000);
        }

        function clearError() {
            errorOverlay.classList.remove('show');
        }

        function runCode() {
            clearError();
            
            // Remove existing canvas
            const container = document.getElementById('p5-container');
            container.innerHTML = '';
            
            // Remove old sketch
            if (currentSketch) {
                currentSketch.remove();
                currentSketch = null;
            }

            // Get user code
            const userCode = editor.getValue();

            try {
                currentSketch = new p5((p) => {
                    try {
                        // Execute user code with p5 in scope via eval
                        eval(userCode);
                    } catch (err) {
                        console.error('Sketch execution error:', err);
                        showError('Execution Error: ' + err.message);
                    }
                }, 'p5-container');

            } catch (err) {
                console.error('Code parsing error:', err);
                showError('Syntax Error: ' + err.message);
            }
        }

        // Run code on load
        runCode();

        // Auto-run on code change (debounced)
        let autoRunTimeout;
        editor.on('change', () => {
            clearTimeout(autoRunTimeout);
            autoRunTimeout = setTimeout(runCode, 1000);
        });
    </script>
</body>
</html>
